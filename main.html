import React, { useState, useEffect, useMemo } from 'react';

const problems = [
  // Two Pointers
  {pattern: 'Two Pointers', name: 'Remove Duplicates from Sorted Array', lc: 26, difficulty: 'Easy'},
  {pattern: 'Two Pointers', name: 'Remove Element', lc: 27, difficulty: 'Easy'},
  {pattern: 'Two Pointers', name: 'Two Sum II', lc: 167, difficulty: 'Medium'},
  {pattern: 'Two Pointers', name: 'Move Zeroes', lc: 283, difficulty: 'Easy'},
  {pattern: 'Two Pointers', name: 'Reverse String', lc: 344, difficulty: 'Easy'},
  {pattern: 'Two Pointers', name: 'Container With Most Water', lc: 11, difficulty: 'Medium'},
  {pattern: 'Two Pointers', name: 'Valid Palindrome', lc: 125, difficulty: 'Easy'},
  {pattern: 'Two Pointers', name: 'Squares of a Sorted Array', lc: 977, difficulty: 'Easy'},
  {pattern: 'Two Pointers', name: '3Sum', lc: 15, difficulty: 'Medium'},
  {pattern: 'Two Pointers', name: 'Trapping Rain Water', lc: 42, difficulty: 'Hard'},
  {pattern: 'Two Pointers', name: 'Palindrome Linked List', lc: 234, difficulty: 'Easy'},
  {pattern: 'Two Pointers', name: 'Remove Nth Node From End', lc: 19, difficulty: 'Medium'},
  
  // Sliding Window
  {pattern: 'Sliding Window', name: 'Maximum Average Subarray I', lc: 643, difficulty: 'Easy'},
  {pattern: 'Sliding Window', name: 'Minimum Size Subarray Sum', lc: 209, difficulty: 'Medium'},
  {pattern: 'Sliding Window', name: 'Longest Substring Without Repeating Characters', lc: 3, difficulty: 'Medium'},
  {pattern: 'Sliding Window', name: 'Permutation in String', lc: 567, difficulty: 'Medium'},
  {pattern: 'Sliding Window', name: 'Find All Anagrams in a String', lc: 438, difficulty: 'Medium'},
  {pattern: 'Sliding Window', name: 'Sliding Window Maximum', lc: 239, difficulty: 'Hard'},
  {pattern: 'Sliding Window', name: 'Longest Repeating Character Replacement', lc: 424, difficulty: 'Medium'},
  {pattern: 'Sliding Window', name: 'Max Consecutive Ones III', lc: 1004, difficulty: 'Medium'},
  
  // Prefix Sum
  {pattern: 'Prefix Sum', name: 'Range Sum Query', lc: 303, difficulty: 'Easy'},
  {pattern: 'Prefix Sum', name: 'Subarray Sum Equals K', lc: 560, difficulty: 'Medium'},
  {pattern: 'Prefix Sum', name: 'Find Pivot Index', lc: 724, difficulty: 'Easy'},
  {pattern: 'Prefix Sum', name: 'Continuous Subarray Sum', lc: 523, difficulty: 'Medium'},
  
  // Fast & Slow Pointer
  {pattern: 'Fast & Slow Pointer', name: 'Linked List Cycle', lc: 141, difficulty: 'Easy'},
  {pattern: 'Fast & Slow Pointer', name: 'Linked List Cycle II', lc: 142, difficulty: 'Medium'},
  {pattern: 'Fast & Slow Pointer', name: 'Happy Number', lc: 202, difficulty: 'Easy'},
  {pattern: 'Fast & Slow Pointer', name: 'Find the Duplicate Number', lc: 287, difficulty: 'Medium'},
  {pattern: 'Fast & Slow Pointer', name: 'Middle of the Linked List', lc: 876, difficulty: 'Easy'},
  
  // Sorting
  {pattern: 'Sorting', name: 'Sort Colors', lc: 75, difficulty: 'Medium'},
  {pattern: 'Sorting', name: 'Merge Sorted Array', lc: 88, difficulty: 'Easy'},
  
  // Intervals
  {pattern: 'Intervals', name: 'Merge Intervals', lc: 56, difficulty: 'Medium'},
  {pattern: 'Intervals', name: 'Insert Interval', lc: 57, difficulty: 'Medium'},
  {pattern: 'Intervals', name: 'Meeting Rooms', lc: 252, difficulty: 'Easy'},
  {pattern: 'Intervals', name: 'Meeting Rooms II', lc: 253, difficulty: 'Medium'},
  {pattern: 'Intervals', name: 'Minimum Number of Arrows to Burst Balloons', lc: 452, difficulty: 'Medium'},
  {pattern: 'Intervals', name: 'Non-overlapping Intervals', lc: 435, difficulty: 'Medium'},
  
  // Binary Search
  {pattern: 'Binary Search', name: 'Binary Search', lc: 704, difficulty: 'Easy'},
  {pattern: 'Binary Search', name: 'Search Insert Position', lc: 35, difficulty: 'Easy'},
  {pattern: 'Binary Search', name: 'Search in Rotated Sorted Array', lc: 33, difficulty: 'Medium'},
  {pattern: 'Binary Search', name: 'Find Peak Element', lc: 162, difficulty: 'Medium'},
  {pattern: 'Binary Search', name: 'Koko Eating Bananas', lc: 875, difficulty: 'Medium'},
  {pattern: 'Binary Search', name: 'Median of Two Sorted Arrays', lc: 4, difficulty: 'Hard'},
  
  // Hashing
  {pattern: 'Hashing', name: 'Two Sum', lc: 1, difficulty: 'Easy'},
  {pattern: 'Hashing', name: 'Group Anagrams', lc: 49, difficulty: 'Medium'},
  {pattern: 'Hashing', name: 'Top K Frequent Elements', lc: 347, difficulty: 'Medium'},
  {pattern: 'Hashing', name: 'Valid Anagram', lc: 242, difficulty: 'Easy'},
  {pattern: 'Hashing', name: 'Longest Consecutive Sequence', lc: 128, difficulty: 'Medium'},
  
  // Stack
  {pattern: 'Stack', name: 'Valid Parentheses', lc: 20, difficulty: 'Easy'},
  {pattern: 'Stack', name: 'Min Stack', lc: 155, difficulty: 'Medium'},
  {pattern: 'Stack', name: 'Daily Temperatures', lc: 739, difficulty: 'Medium'},
  {pattern: 'Stack', name: 'Next Greater Element I', lc: 496, difficulty: 'Easy'},
  {pattern: 'Stack', name: 'Largest Rectangle in Histogram', lc: 84, difficulty: 'Hard'},
  
  // Queue
  {pattern: 'Queue', name: 'Binary Tree Level Order Traversal', lc: 102, difficulty: 'Medium'},
  {pattern: 'Queue', name: 'Rotting Oranges', lc: 994, difficulty: 'Medium'},
  {pattern: 'Queue', name: 'Course Schedule', lc: 207, difficulty: 'Medium'},
  
  // Heap
  {pattern: 'Heap', name: 'Kth Largest Element in an Array', lc: 215, difficulty: 'Medium'},
  {pattern: 'Heap', name: 'Merge K Sorted Lists', lc: 23, difficulty: 'Hard'},
  {pattern: 'Heap', name: 'Find Median from Data Stream', lc: 295, difficulty: 'Hard'},
  {pattern: 'Heap', name: 'Task Scheduler', lc: 621, difficulty: 'Medium'},
  
  // Tree DFS
  {pattern: 'Tree DFS', name: 'Maximum Depth of Binary Tree', lc: 104, difficulty: 'Easy'},
  {pattern: 'Tree DFS', name: 'Diameter of Binary Tree', lc: 543, difficulty: 'Easy'},
  {pattern: 'Tree DFS', name: 'Invert Binary Tree', lc: 226, difficulty: 'Easy'},
  {pattern: 'Tree DFS', name: 'Validate Binary Search Tree', lc: 98, difficulty: 'Medium'},
  {pattern: 'Tree DFS', name: 'Path Sum', lc: 112, difficulty: 'Easy'},
  
  // Tree BFS
  {pattern: 'Tree BFS', name: 'Binary Tree Level Order Traversal', lc: 102, difficulty: 'Medium'},
  {pattern: 'Tree BFS', name: 'Binary Tree Right Side View', lc: 199, difficulty: 'Medium'},
  
  // Graph
  {pattern: 'Graph', name: 'Number of Islands', lc: 200, difficulty: 'Medium'},
  {pattern: 'Graph', name: 'Clone Graph', lc: 133, difficulty: 'Medium'},
  {pattern: 'Graph', name: 'Course Schedule', lc: 207, difficulty: 'Medium'},
  {pattern: 'Graph', name: 'Pacific Atlantic Water Flow', lc: 417, difficulty: 'Medium'},
  
  // Dijkstra
  {pattern: 'Dijkstra', name: 'Network Delay Time', lc: 743, difficulty: 'Medium'},
  {pattern: 'Dijkstra', name: 'Path With Minimum Effort', lc: 1631, difficulty: 'Medium'},
  
  // Trie
  {pattern: 'Trie', name: 'Implement Trie', lc: 208, difficulty: 'Medium'},
  {pattern: 'Trie', name: 'Word Search II', lc: 212, difficulty: 'Hard'},
  
  // Greedy
  {pattern: 'Greedy', name: 'Jump Game', lc: 55, difficulty: 'Medium'},
  {pattern: 'Greedy', name: 'Jump Game II', lc: 45, difficulty: 'Medium'},
  {pattern: 'Greedy', name: 'Gas Station', lc: 134, difficulty: 'Medium'},
  
  // Dynamic Programming
  {pattern: 'Dynamic Programming', name: 'Climbing Stairs', lc: 70, difficulty: 'Easy'},
  {pattern: 'Dynamic Programming', name: 'House Robber', lc: 198, difficulty: 'Medium'},
  {pattern: 'Dynamic Programming', name: 'Longest Common Subsequence', lc: 1143, difficulty: 'Medium'},
  {pattern: 'Dynamic Programming', name: 'Edit Distance', lc: 72, difficulty: 'Hard'},
  {pattern: 'Dynamic Programming', name: 'Unique Paths', lc: 62, difficulty: 'Medium'},
  
  // Backtracking
  {pattern: 'Backtracking', name: 'Subsets', lc: 78, difficulty: 'Medium'},
  {pattern: 'Backtracking', name: 'Permutations', lc: 46, difficulty: 'Medium'},
  {pattern: 'Backtracking', name: 'Combination Sum', lc: 39, difficulty: 'Medium'},
  {pattern: 'Backtracking', name: 'N-Queens', lc: 51, difficulty: 'Hard'},
  
  // Bit Manipulation
  {pattern: 'Bit Manipulation', name: 'Single Number', lc: 136, difficulty: 'Easy'},
  {pattern: 'Bit Manipulation', name: 'Counting Bits', lc: 338, difficulty: 'Easy'},
  {pattern: 'Bit Manipulation', name: 'Number of 1 Bits', lc: 191, difficulty: 'Easy'}
];

export default function DSATracker() {
  const [solvedData, setSolvedData] = useState({});
  const [notesData, setNotesData] = useState({});
  const [patternFilter, setPatternFilter] = useState('all');
  const [difficultyFilter, setDifficultyFilter] = useState('all');
  const [statusFilter, setStatusFilter] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');

  useEffect(() => {
    const saved = localStorage.getItem('dsaSolved');
    const savedNotes = localStorage.getItem('dsaNotes');
    if (saved) setSolvedData(JSON.parse(saved));
    if (savedNotes) setNotesData(JSON.parse(savedNotes));
  }, []);

  const patterns = useMemo(() => {
    return [...new Set(problems.map(p => p.pattern))].sort();
  }, []);

  const getKey = (p) => `${p.lc}-${slugify(p.name)}`;
  
  const slugify = (text) => text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');

  const toggleSolved = (key) => {
    const newSolved = { ...solvedData };
    if (newSolved[key]) {
      delete newSolved[key];
    } else {
      newSolved[key] = true;
    }
    setSolvedData(newSolved);
    localStorage.setItem('dsaSolved', JSON.stringify(newSolved));
  };

  const saveNote = (key, value) => {
    const newNotes = { ...notesData, [key]: value };
    setNotesData(newNotes);
    localStorage.setItem('dsaNotes', JSON.stringify(newNotes));
  };

  const filteredProblems = useMemo(() => {
    let filtered = problems;
    if (patternFilter !== 'all') filtered = filtered.filter(p => p.pattern === patternFilter);
    if (difficultyFilter !== 'all') filtered = filtered.filter(p => p.difficulty === difficultyFilter);
    if (searchTerm) filtered = filtered.filter(p => 
      p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      p.pattern.toLowerCase().includes(searchTerm.toLowerCase())
    );
    if (statusFilter === 'solved') filtered = filtered.filter(p => solvedData[getKey(p)]);
    if (statusFilter === 'unsolved') filtered = filtered.filter(p => !solvedData[getKey(p)]);
    return filtered;
  }, [patternFilter, difficultyFilter, statusFilter, searchTerm, solvedData]);

  const stats = useMemo(() => {
    const total = problems.length;
    const solved = Object.keys(solvedData).length;
    let easy = 0, medium = 0, hard = 0;
    
    problems.forEach(p => {
      const key = getKey(p);
      if (solvedData[key]) {
        if (p.difficulty === 'Easy') easy++;
        if (p.difficulty === 'Medium') medium++;
        if (p.difficulty === 'Hard') hard++;
      }
    });

    const percent = total === 0 ? 0 : Math.round((solved / total) * 100);
    return { total, solved, easy, medium, hard, percent };
  }, [solvedData]);

  const exportToCSV = () => {
    let csv = 'Problem,LeetCode,Pattern,Difficulty,Solved,Notes\n';
    problems.forEach(p => {
      const key = getKey(p);
      const solved = solvedData[key] ? 'Yes' : 'No';
      const notes = (notesData[key] || '').replace(/"/g, '""');
      csv += `"${p.name}",${p.lc},"${p.pattern}",${p.difficulty},${solved},"${notes}"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'DSA_Master_Tracker.csv';
    link.click();
  };

  const resetProgress = () => {
    if (!confirm('This will clear all progress and notes. Continue?')) return;
    setSolvedData({});
    setNotesData({});
    localStorage.removeItem('dsaSolved');
    localStorage.removeItem('dsaNotes');
  };

  return (
    <div className="min-h-screen bg-black text-white">
      <div className="max-w-[1600px] mx-auto">
        {/* Header */}
        <div className="sticky top-0 z-50 border-b border-zinc-800 bg-zinc-950/95 backdrop-blur-lg">
          <div className="px-6 py-6 md:px-10">
            <div className="flex items-center justify-between mb-5">
              <div className="flex items-center gap-3">
                <div className="w-8 h-8 bg-white rounded-md flex items-center justify-center font-bold text-black text-lg">
                  D
                </div>
                <h1 className="text-2xl font-semibold tracking-tight">DSA Master Tracker</h1>
              </div>
            </div>
            
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
              <div className="bg-zinc-900 border border-zinc-800 rounded-lg p-4 hover:border-zinc-700 transition-colors">
                <div className="text-xs text-zinc-400 uppercase tracking-wide mb-2">Total</div>
                <div className="text-3xl font-bold tracking-tight">{stats.total}</div>
              </div>
              <div className="bg-zinc-900 border border-zinc-800 rounded-lg p-4 hover:border-zinc-700 transition-colors">
                <div className="text-xs text-zinc-400 uppercase tracking-wide mb-2">Solved</div>
                <div className="text-3xl font-bold tracking-tight">{stats.solved}</div>
                <div className="h-1 bg-zinc-800 rounded-full mt-2 overflow-hidden">
                  <div className="h-full bg-white transition-all duration-300" style={{ width: `${stats.percent}%` }} />
                </div>
              </div>
              <div className="bg-zinc-900 border border-zinc-800 rounded-lg p-4 hover:border-zinc-700 transition-colors">
                <div className="text-xs text-zinc-400 uppercase tracking-wide mb-2">Easy</div>
                <div className="text-3xl font-bold tracking-tight text-emerald-400">{stats.easy}</div>
              </div>
              <div className="bg-zinc-900 border border-zinc-800 rounded-lg p-4 hover:border-zinc-700 transition-colors">
                <div className="text-xs text-zinc-400 uppercase tracking-wide mb-2">Medium</div>
                <div className="text-3xl font-bold tracking-tight text-yellow-400">{stats.medium}</div>
              </div>
              <div className="bg-zinc-900 border border-zinc-800 rounded-lg p-4 hover:border-zinc-700 transition-colors">
                <div className="text-xs text-zinc-400 uppercase tracking-wide mb-2">Hard</div>
                <div className="text-3xl font-bold tracking-tight text-red-400">{stats.hard}</div>
              </div>
              <div className="bg-zinc-900 border border-zinc-800 rounded-lg p-4 hover:border-zinc-700 transition-colors">
                <div className="text-xs text-zinc-400 uppercase tracking-wide mb-2">Progress</div>
                <div className="text-3xl font-bold tracking-tight">{stats.percent}%</div>
              </div>
            </div>
          </div>
        </div>

        {/* Controls */}
        <div className="px-6 py-6 md:px-10 bg-zinc-950 border-b border-zinc-800 flex flex-wrap gap-3">
          <div className="flex-1 min-w-[280px] relative">
            <span className="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-600 pointer-events-none">üîç</span>
            <input
              type="text"
              placeholder="Search problems..."
              className="w-full pl-11 pr-4 py-3 bg-zinc-900 border border-zinc-800 rounded-lg text-sm text-white placeholder-zinc-600 focus:outline-none focus:border-zinc-600 focus:bg-black transition-all"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
          </div>
          
          <select
            className="px-4 py-3 bg-zinc-900 border border-zinc-800 rounded-lg text-sm text-white cursor-pointer hover:border-zinc-600 focus:outline-none focus:border-zinc-600 transition-colors min-w-[180px]"
            value={patternFilter}
            onChange={(e) => setPatternFilter(e.target.value)}
          >
            <option value="all">All Patterns</option>
            {patterns.map(p => <option key={p} value={p}>{p}</option>)}
          </select>

          <select
            className="px-4 py-3 bg-zinc-900 border border-zinc-800 rounded-lg text-sm text-white cursor-pointer hover:border-zinc-600 focus:outline-none focus:border-zinc-600 transition-colors"
            value={difficultyFilter}
            onChange={(e) => setDifficultyFilter(e.target.value)}
          >
            <option value="all">All Difficulties</option>
            <option value="Easy">Easy</option>
            <option value="Medium">Medium</option>
            <option value="Hard">Hard</option>
          </select>

          <select
            className="px-4 py-3 bg-zinc-900 border border-zinc-800 rounded-lg text-sm text-white cursor-pointer hover:border-zinc-600 focus:outline-none focus:border-zinc-600 transition-colors"
            value={statusFilter}
            onChange={(e) => setStatusFilter(e.target.value)}
          >
            <option value="all">All Status</option>
            <option value="solved">Solved</option>
            <option value="unsolved">Unsolved</option>
          </select>

          <button
            onClick={exportToCSV}
            className="px-5 py-3 bg-white text-black rounded-lg text-sm font-semibold hover:opacity-90 hover:-translate-y-0.5 transition-all flex items-center gap-2"
          >
            <span>üì•</span> Export CSV
          </button>

          <button
            onClick={resetProgress}
            className="px-5 py-3 bg-zinc-900 border border-zinc-800 text-white rounded-lg text-sm font-semibold hover:border-zinc-600 transition-colors flex items-center gap-2"
          >
            <span>üîÑ</span> Reset
          </button>
        </div>

        {/* Table */}
        <div className="px-6 pb-10 md:px-10 overflow-x-auto">
          <table className="w-full">
            <thead className="sticky top-[160px] bg-black z-10">
              <tr className="border-b border-zinc-800">
                <th className="px-4 py-4 text-left text-xs font-semibold text-zinc-400 uppercase tracking-wide w-12">‚úì</th>
                <th className="px-4 py-4 text-left text-xs font-semibold text-zinc-400 uppercase tracking-wide">Problem</th>
                <th className="px-4 py-4 text-left text-xs font-semibold text-zinc-400 uppercase tracking-wide">Difficulty</th>
                <th className="px-4 py-4 text-left text-xs font-semibold text-zinc-400 uppercase tracking-wide">Pattern</th>
                <th className="px-4 py-4 text-left text-xs font-semibold text-zinc-400 uppercase tracking-wide">Link</th>
                <th className="px-4 py-4 text-left text-xs font-semibold text-zinc-400 uppercase tracking-wide w-48">Notes</th>
              </tr>
            </thead>
            <tbody>
              {filteredProblems.map((p) => {
                const key = getKey(p);
                const isSolved = solvedData[key];
                return (
                  <tr key={key} className={`border-b border-zinc-800 hover:bg-zinc-950 transition-colors ${isSolved ? 'opacity-50' : ''}`}>
                    <td className="px-4 py-5 text-center">
                      <div
                        onClick={() => toggleSolved(key)}
                        className={`inline-block w-5 h-5 border-2 rounded cursor-pointer transition-all hover:border-zinc-400 ${
                          isSolved ? 'bg-white border-white' : 'border-zinc-800'
                        }`}
                      >
                        {isSolved && <div className="text-black text-xs font-bold leading-none flex items-center justify-center h-full">‚úì</div>}
                      </div>
                    </td>
                    <td className="px-4 py-5">
                      <div className="flex items-center gap-3">
                        <span className="text-zinc-600 text-xs min-w-[45px] hidden md:inline">#{p.lc}</span>
                        <span className="text-white font-medium text-sm">{p.name}</span>
                      </div>
                    </td>
                    <td className="px-4 py-5">
                      <span className={`inline-block px-2.5 py-1 rounded text-[11px] font-semibold uppercase tracking-wide border ${
                        p.difficulty === 'Easy' ? 'bg-emerald-400/10 text-emerald-400 border-emerald-400/20' :
                        p.difficulty === 'Medium' ? 'bg-yellow-400/10 text-yellow-400 border-yellow-400/20' :
                        'bg-red-400/10 text-red-400 border-red-400/20'
                      }`}>
                        {p.difficulty}
                      </span>
                    </td>
                    <td className="px-4 py-5">
                      <span className="inline-block px-3 py-1.5 bg-zinc-900 border border-zinc-800 rounded text-xs font-medium text-zinc-400 whitespace-nowrap">
                        {p.pattern}
                      </span>
                    </td>
                    <td className="px-4 py-5">
                      <a
                        href={`https://leetcode.com/problems/${slugify(p.name)}/`}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="text-zinc-400 hover:text-white transition-colors text-xs"
                      >
                        LeetCode ‚Üí
                      </a>
                    </td>
                    <td className="px-4 py-5">
                      <textarea
                        placeholder="Add notes..."
                        rows="1"
                        className="w-full px-3 py-2 bg-zinc-900 border border-zinc-800 rounded text-xs text-white placeholder-zinc-600 resize-none focus:outline-none focus:border-zinc-600 focus:bg-black transition-all"
                        value={notesData[key] || ''}
                        onChange={(e) => saveNote(key, e.target.value)}
                      />
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}